@model MVCTest.Repository.MomentsRepository
@using Microsoft.AspNet.Identity
@{
    ViewBag.Title = "Index";
}
<script type="text/javascript">
    function UnLikedClick(id, e) {
        $.ajax({
            url: '/Moments/UnLiked/' + id,
            type: 'GET',
            success: function (data) {
                $('#' + id).html('<p align="right">点赞者：' + data + '</p>');
                $('#' + id + '-LikeLink').attr("onclick", "LikedClick(" + id + ",this)");
                $('#' + id + '-LikeLink').html("点赞");
            }
        });
        //$('#' + id).load('/Notes/UnLiked/' + id);
        //$('#' + id + '-LikeLink').attr("onclick", "LikedClick(" + id + ",this)");
        //$('#' + id + '-LikeLink').html("点赞");
    }

    function LikedClick(id, e) {
        $.ajax({
            url: '/Moments/Liked/' + id,
            type: 'GET',
            success: function (data) {
                $('#' + id).html('<p align="right">点赞者：' + data + '</p>');
                $('#' + id + '-LikeLink').attr("onclick", "UnLikedClick(" + id + ",this)");
                $('#' + id + '-LikeLink').html("取消点赞");
            }
        });
        //$('#' + id).load('/Notes/Liked/' + id);
        //$('#' + id + '-LikeLink').attr("onclick", "UnLikedClick(" + id + ",this)");
        //$('#' + id + '-LikeLink').html("取消点赞");
    }
</script>
<h2>朋友圈2.0</h2>

<p>
    @if (Request.IsAuthenticated)
    {
        @Html.ActionLink("发布朋友圈", "Create")
    }
    else
    {
        @Html.ActionLink("发布朋友圈", "Login", "Account", routeValues: null, htmlAttributes: new { id = "loginLink" })
    }
</p>
<hr style="height:1px;border:none;border-top:1px solid #555555;" />
@{
    IEnumerable<MVCTest.Notes> m = Model.OrderAllNotesByDescending();
}
@foreach (var item in m)
{
    <p><b>用户名：@Model.GetNickNameByNote(item)</b></p>
    <p>@item.Text</p>
    if (Model.IsForward(item))
    {
        List<Notes> ml = m.ToList();
        Notes a = ml.Find(x => x.NoteId == Model.GetForwardedNote(item).NoteId);
        <div style="background-color:rgba(100, 100, 100, 0.15);padding:10px 5px;"><b>@Model.GetNickNameByNote(a)</b>：@a.Text</div>
    }
    <p align="right">@item.Time.ToString()</p>
    <div id="@item.NoteId"><p align="right">点赞者：@Model.GetLikesOnNote(item)</p></div>
    
    <p>
        @Html.ActionLink("Edit", "Edit", new { id = item.NoteId }) |
        @Html.ActionLink("Details", "Details", new { id = item.NoteId }) |
        @Html.ActionLink("Delete", "Delete", new { id = item.NoteId }) |
        @if (Request.IsAuthenticated)
        {
            var isFound = Model.IsCurrentUserLikesNote(item, User.Identity.GetUserName());
            if (isFound ==true)
            {
                <a id="@item.NoteId-LikeLink" href="javascript:void(0);" onclick="UnLikedClick(@item.NoteId,this)">取消点赞</a>
            }
            else
            {
                <a id="@item.NoteId-LikeLink" href="javascript:void(0);" onclick="LikedClick(@item.NoteId,this)">点赞</a>
            }
        }
        else
        {
            @Html.ActionLink("点赞", "Login", "Account", routeValues: null, htmlAttributes: new { id = "loginLink" })
        } |
        @if (Request.IsAuthenticated)
        {
            @Html.ActionLink("转发", "Relay", new { id = item.NoteId })
        }
        else
        {
            @Html.ActionLink("转发", "Login", "Account", routeValues: null, htmlAttributes: new { id = "loginLink" })
        }
    </p>
    <hr style="height:1px;border:none;border-top:1px solid #555555;" />
}